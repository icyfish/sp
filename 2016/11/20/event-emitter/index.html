<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="google-site-verification" content="IDYUPnBNhdnU8o9LRNKZ1RSt14tIxTI0rLeMrBtswXw"><title> 理解Event Emitter · Fish</title><meta name="description" content="理解Event Emitter - Fish"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/posts/favicon.png"><link rel="stylesheet" href="/posts/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://icyfish.github.io/posts/atom.xml" title="Fish"></head><body><div class="wrap"><header><a href="/posts/" class="logo-link"><img src="/posts/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/posts/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/posts/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/posts/about/" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="http://twitter.com/icyfish_" target="_blank" class="nav-list-link">TWITTER</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">理解Event Emitter</h1><div class="post-info">Nov 20, 2016</div><div class="post-content"><p>Node中很多模块都运用了Event Emitter, 以下是对Event Emitter的介绍及在Node中的实现方式, 还介绍了在JavaScript中实现继承的几种方式.</p>
<a id="more"></a>
<h2 id="Node中的事件"><a href="#Node中的事件" class="headerlink" title="Node中的事件"></a>Node中的事件</h2><p>Node需要处理两种类型的事件. </p>
<p>1.<strong>系统事件(System Events)</strong>(C++ Core [libuv])</p>
<p>It comes from the c++ side of node.js core, thanks to a library called libuv.</p>
<p>操作系统相关的事件, 例如:</p>
<ul>
<li>读取文件</li>
<li>获取来自互联网的数据 </li>
</ul>
<p>2.<strong>定制事件(Custom Events)</strong>(JavaScript core [Event Emitter])</p>
<p>When a event occurs in libuv, it generates a Custom JavaScript event to make it easier for us to decide what code should run when that event happens.</p>
<p>Actually JavaScript is faking event because it does not have event object.</p>
<h2 id="EventEmitter的实现原理-简化版"><a href="#EventEmitter的实现原理-简化版" class="headerlink" title="EventEmitter的实现原理(简化版)"></a>EventEmitter的实现原理(简化版)</h2><p><em>emitter.js</em></p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Emitter</span>(<span class="hljs-params"></span>)</span>&#123;</span><br><span class="line">  <span class="hljs-keyword">this</span>.events = &#123;&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Emitter.prototype.on = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">type, listener</span>)</span>&#123;</span><br><span class="line">  <span class="hljs-comment">// 在事件对象中加入新的属性</span></span><br><span class="line">  <span class="hljs-comment">// 确保新的属性以数组的形式保存</span></span><br><span class="line">  <span class="hljs-keyword">this</span>.events[type] = <span class="hljs-keyword">this</span>.events[type] || [];</span><br><span class="line">  <span class="hljs-comment">// 在数组中加入事件处理函数</span></span><br><span class="line">  <span class="hljs-keyword">this</span>.events[type].push(listener);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// &#123;</span></span><br><span class="line"><span class="hljs-comment">//   gotSomthingFromInternet: [function()&#123;&#125;, function()&#123;&#125;]</span></span><br><span class="line"><span class="hljs-comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">Emitter.prototype.emit = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">type</span>)</span>&#123;</span><br><span class="line">  <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.events[type]) &#123;<span class="hljs-comment">// 如果事件对象中含有该属性</span></span><br><span class="line">    <span class="hljs-keyword">this</span>.events[type].forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">listener</span>)</span>&#123;</span><br><span class="line">      listener();</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-built_in">module</span>.exports = Emitter;</span><br></pre></td></tr></table></figure>
<p><em>app.js</em></p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">var</span> Emitter = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./emitter'</span>);</span><br><span class="line"><span class="hljs-comment">// var Emitter = require('events'); Node内置模块events</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">var</span> emtr = <span class="hljs-keyword">new</span> Emitter();</span><br><span class="line"></span><br><span class="line">emtr.on(<span class="hljs-string">'greet'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123;</span><br><span class="line">  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Somewhere, someone said hello.'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">emtr.on(<span class="hljs-string">'greet'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123;</span><br><span class="line">  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'A greeting occurred!'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"> </span><br><span class="line">emtr.emit(<span class="hljs-string">'greet'</span>);</span><br></pre></td></tr></table></figure>
<p><strong>Magic String</strong></p>
<p>代码中含有特殊含义的字符串, 传入emit和on方法中的第一个参数就是Magic String, 上例中为’greet’. 直接以字符串的形式传入会使调试变困难.</p>
<p>可以这样解决该问题(不容易犯错, 更易控制):</p>
<p>添加一个配置文件<code>config.js</code>:</p>
<p><em>config.js</em></p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-built_in">module</span>.exports = &#123;</span><br><span class="line">  events: &#123;</span><br><span class="line">    GREET: <span class="hljs-string">'greet'</span>,</span><br><span class="line">    FILESAVED: <span class="hljs-string">'filesaved'</span>,</span><br><span class="line">    FILEOPENED: <span class="hljs-string">'fileopened'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>app.js</em></p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">var</span> Emitter = <span class="hljs-built_in">require</span>(<span class="hljs-string">'events'</span>);</span><br><span class="line"><span class="hljs-keyword">var</span> eventConfig = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./config'</span>).events;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">var</span> emtr = <span class="hljs-keyword">new</span> Emitter(); </span><br><span class="line"></span><br><span class="line">emtr.on(eventConfig.GREET, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123;</span><br><span class="line">  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Somewhere, someone said hello.'</span>);</span><br><span class="line">&#125;); </span><br><span class="line"></span><br><span class="line">emtr.on(eventConfig.GREET, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123;</span><br><span class="line">  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'A greeting occurred!'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"> </span><br><span class="line">emtr.emit(<span class="hljs-string">'greet'</span>);</span><br></pre></td></tr></table></figure>
<h2 id="从EventEmitter继承"><a href="#从EventEmitter继承" class="headerlink" title="从EventEmitter继承"></a>从EventEmitter继承</h2><p><strong>继承的方法inherits实现</strong></p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">exports.inherits = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">ctor, superCtor</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">if</span> (ctor === <span class="hljs-literal">undefined</span> || ctor === <span class="hljs-literal">null</span>)</span><br><span class="line">    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">TypeError</span>(<span class="hljs-string">'The constructor to "inherits" must not be '</span> +</span><br><span class="line">                        <span class="hljs-string">'null or undefined'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">if</span> (superCtor === <span class="hljs-literal">undefined</span> || superCtor === <span class="hljs-literal">null</span>)</span><br><span class="line">    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">TypeError</span>(<span class="hljs-string">'The super constructor to "inherits" must not '</span> +</span><br><span class="line">                        <span class="hljs-string">'be null or undefined'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">if</span> (superCtor.prototype === <span class="hljs-literal">undefined</span>)</span><br><span class="line">    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">TypeError</span>(<span class="hljs-string">'The super constructor to "inherits" must '</span> +</span><br><span class="line">                        <span class="hljs-string">'have a prototype'</span>);</span><br><span class="line"></span><br><span class="line">  ctor.super_ = superCtor;</span><br><span class="line">  <span class="hljs-built_in">Object</span>.setPrototypeOf(ctor.prototype, superCtor.prototype);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><img src="/posts/images/util-inherits.jpg" alt="util-inherits"></p>
<p><strong>使用inherits继承EventEmitter</strong></p>
<p>Node中许多内置对象都从EventEmitter继承</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">var</span> EventEmitter = <span class="hljs-built_in">require</span>(<span class="hljs-string">'events'</span>);</span><br><span class="line"><span class="hljs-keyword">var</span> util = <span class="hljs-built_in">require</span>(<span class="hljs-string">'util'</span>);</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Greetr</span>(<span class="hljs-params"></span>)</span>&#123;</span><br><span class="line">  EventEmitter.call(<span class="hljs-keyword">this</span>); <span class="hljs-comment">// super constructor </span></span><br><span class="line">  <span class="hljs-comment">// 确保从该函数构造器中创建出的对象继承所有EventEmitter的属性, 因为inherits只使对象继承prototype中的属性, 没有继承构造器本身的属性(下面有示例)</span></span><br><span class="line">  <span class="hljs-keyword">this</span>.greeting = <span class="hljs-string">"Hello World!"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// 使Greetr继承EventEmitter的prototype的属性 </span></span><br><span class="line">util.inherits(Greetr, EventEmitter);</span><br><span class="line"> </span><br><span class="line">Greetr.prototype.greet = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>)</span>&#123;</span><br><span class="line">  <span class="hljs-built_in">console</span>.log(<span class="hljs-keyword">this</span>.greeting + <span class="hljs-string">': '</span>+ data);</span><br><span class="line">  <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'greet'</span>,data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">var</span> greeter1 = <span class="hljs-keyword">new</span> Greetr();</span><br><span class="line"></span><br><span class="line">greeter1.on(<span class="hljs-string">'greet'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>)</span>&#123;</span><br><span class="line">  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Someone greeted!: '</span> + data);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">greeter1.greet(<span class="hljs-string">'Tony'</span>);</span><br></pre></td></tr></table></figure>
<p><img src="/posts/images/event-inherits.jpg" alt="event-inherits"></p>
<p><strong>确保继承完整性</strong></p>
<p>inherits只使对象继承prototype中的属性, 没有继承构造器本身的属性, 利用<code>构造器.call(this)</code>确保继承完全.</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">var</span> util = <span class="hljs-built_in">require</span>(<span class="hljs-string">'util'</span>);</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Person</span>(<span class="hljs-params"></span>) </span>&#123;</span><br><span class="line">	<span class="hljs-keyword">this</span>.firstname = <span class="hljs-string">'John'</span>;</span><br><span class="line">	<span class="hljs-keyword">this</span>.lastname = <span class="hljs-string">'Doe'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Person.prototype.greet = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>&#123;</span><br><span class="line">	<span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Hello '</span> + <span class="hljs-keyword">this</span>.firstname + <span class="hljs-string">' '</span> + <span class="hljs-keyword">this</span>.lastname);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Policeman</span>(<span class="hljs-params"></span>) </span>&#123;</span><br><span class="line">	<span class="hljs-comment">//Person.call(this);</span></span><br><span class="line">	<span class="hljs-keyword">this</span>.badgenumber = <span class="hljs-string">'1234'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">util.inherits(Policeman, Person);</span><br><span class="line"><span class="hljs-keyword">var</span> officer = <span class="hljs-keyword">new</span> Policeman();</span><br><span class="line">officer.greet(); </span><br><span class="line"><span class="hljs-comment">// Hello undefined undefined</span></span><br></pre></td></tr></table></figure>
<p>在Policeman构造器中调用<code>Person.call(this);</code>后, 从Policeman中实例化出的对象的属性就不只继承自原型链, 还有<code>Person</code>构造器中定义的属性, 这样再调用<code>office.greet()</code>, 结果就是: `Hello John Doe’.</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">var</span> util = <span class="hljs-built_in">require</span>(<span class="hljs-string">'util'</span>);</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Person</span>(<span class="hljs-params"></span>) </span>&#123;</span><br><span class="line">	<span class="hljs-keyword">this</span>.firstname = <span class="hljs-string">'John'</span>;</span><br><span class="line">	<span class="hljs-keyword">this</span>.lastname = <span class="hljs-string">'Doe'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Person.prototype.greet = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>&#123;</span><br><span class="line">	<span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Hello '</span> + <span class="hljs-keyword">this</span>.firstname + <span class="hljs-string">' '</span> + <span class="hljs-keyword">this</span>.lastname);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Policeman</span>(<span class="hljs-params"></span>) </span>&#123;</span><br><span class="line">	Person.call(<span class="hljs-keyword">this</span>);</span><br><span class="line">	<span class="hljs-keyword">this</span>.badgenumber = <span class="hljs-string">'1234'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">util.inherits(Policeman, Person);</span><br><span class="line"><span class="hljs-keyword">var</span> officer = <span class="hljs-keyword">new</span> Policeman();</span><br><span class="line">officer.greet();</span><br><span class="line"><span class="hljs-comment">//Hello John Doe</span></span><br></pre></td></tr></table></figure>
<p><strong>使用ES6 class重构上述代码</strong></p>
<p>class只是语法糖, 并不是其他编程语言中的”类”.</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Person</span> </span>&#123;</span><br><span class="line">  <span class="hljs-keyword">constructor</span>(firstname, lastname)&#123;</span><br><span class="line">    <span class="hljs-keyword">this</span>.firstname = <span class="hljs-string">'John'</span>;</span><br><span class="line">    <span class="hljs-keyword">this</span>.lastname = <span class="hljs-string">'Doe'</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  greet()&#123;</span><br><span class="line">	  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`Hello <span class="hljs-subst">$&#123;<span class="hljs-keyword">this</span>.firstname&#125;</span> <span class="hljs-subst">$&#123;<span class="hljs-keyword">this</span>.lastname&#125;</span>`</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Policeman</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Person</span> </span>&#123;</span><br><span class="line">	<span class="hljs-keyword">constructor</span>( )&#123;</span><br><span class="line">		<span class="hljs-keyword">super</span>(); <span class="hljs-comment">// 相当于Person.call(this) </span></span><br><span class="line">    <span class="hljs-keyword">this</span>.badgenumber = <span class="hljs-string">'1234'</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="hljs-keyword">var</span> officer = <span class="hljs-keyword">new</span> Policeman();</span><br><span class="line">officer.greet();</span><br></pre></td></tr></table></figure>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">var</span> EventEmiiter = <span class="hljs-built_in">require</span>(<span class="hljs-string">'events'</span>);</span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Greetr</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">EventEmiiter</span> </span>&#123;</span><br><span class="line">	<span class="hljs-keyword">constructor</span>()&#123;</span><br><span class="line">		<span class="hljs-keyword">super</span>(); <span class="hljs-comment">// 相当于EventEmitter.call(this)</span></span><br><span class="line">		<span class="hljs-keyword">this</span>.greeting = <span class="hljs-string">"Hello World!"</span>;</span><br><span class="line">	&#125;</span><br><span class="line">  greet(data)&#123;</span><br><span class="line">    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`<span class="hljs-subst">$&#123;<span class="hljs-keyword">this</span>.greeting&#125;</span>: <span class="hljs-subst">$&#123;data&#125;</span>`</span>);</span><br><span class="line">    <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'greet'</span>, data);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">var</span> greeter1 = <span class="hljs-keyword">new</span> Greetr();</span><br><span class="line">greeter1.on(<span class="hljs-string">'greet'</span>, (data) =&gt; &#123;</span><br><span class="line">  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`Someone greeted!: <span class="hljs-subst">$&#123;data&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">greeter1.greet(<span class="hljs-string">'Tony'</span>);</span><br></pre></td></tr></table></figure>
<p><em>class使用module.exports:</em></p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">var</span> EventEmitter = <span class="hljs-built_in">require</span>(<span class="hljs-string">'events'</span>);</span><br><span class="line"></span><br><span class="line"><span class="hljs-built_in">module</span>.exports = <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Greetr</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">EventEmiiter</span> </span>&#123;</span><br><span class="line">	<span class="hljs-keyword">constructor</span>()&#123;</span><br><span class="line">		<span class="hljs-keyword">super</span>();</span><br><span class="line">		<span class="hljs-keyword">this</span>.greeting = <span class="hljs-string">"Hello world"</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>参考</strong></p>
<ul>
<li><a href="https://www.udemy.com/understand-nodejs/" target="_blank" rel="noopener">Learn and Understand NodeJS</a></li>
</ul>
</div></article></div></main><footer><div class="paginator"><a href="/posts/2016/11/29/async-n-event/" class="prev">PREV</a><a href="/posts/2016/11/15/closure/" class="next">NEXT</a></div><div class="copyright"><p>© 2019 - 2021 <a href="https://icyfish.github.io/posts">Fish</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>